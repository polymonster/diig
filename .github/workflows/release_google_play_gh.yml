name: release_google_play_gh
on:
  workflow_dispatch:
jobs:
  release_google_play:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - name: setup_jdk
      uses: actions/setup-java@v1
      with:
        java-version: 21.0
    - name: setup_gradle
      uses: gradle/actions/setup-gradle@v3
      with:
          gradle-version: 8.14.3 
    - name: setup_env
      run: |
        echo $env:ANDROID_HOME
        echo $env:JAVA_HOME
        echo $env:PATH
        java -version
    - name: resolve_secrets
      run: |
        absPath=$(realpath app/dist/android/upload-keystore.jks)
        echo "ABS_KEYSTORE_PATH=$absPath" >> "$GITHUB_ENV"
        echo '${{secrets.ANDROID_API_KEY_H}} >> app/code/api_key.h
    - name: build
      run: |
        cd app
        pmbuild android
        cd build/android
        gradle.bat wrapper
        ./gradlew.bat bundleRelease "-Pandroid.injected.signing.store.file=${env:ABS_KEYSTORE_PATH}" "-Pandroid.injected.signing.store.password=${{secrets.GOOGLE_PLAY_SIGNING_KEYSTORE_PASSWORD}}" "-Pandroid.injected.signing.key.alias=upload-key" "-Pandroid.injected.signing.key.password=${{secrets.GOOGLE_PLAY_SIGNING_KEYSTORE_PASSWORD}}"
    - name: upload
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{secrets.SERVICE_ACCOUNT_JSON}}
        packageName: pmtech.diig
        releaseFiles: "app/build/android/diig/build/outputs/bundle/release/diig-release.aab"
        track: internal
        status: draft

